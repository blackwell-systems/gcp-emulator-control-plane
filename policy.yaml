# GCP Emulator Control Plane - Policy Configuration
#
# This single policy file controls authorization across all emulators in the stack.

# Custom Roles
# Define your own role-to-permission mappings for any GCP service
roles:
  # CI Runner - limited access to secrets and encryption
  roles/custom.ciRunner:
    permissions:
      - secretmanager.secrets.get
      - secretmanager.versions.access
      - cloudkms.cryptoKeys.encrypt
      - cloudkms.cryptoKeys.decrypt

  # Developer - read access to secrets and keys
  roles/custom.developer:
    permissions:
      - secretmanager.secrets.get
      - secretmanager.secrets.list
      - secretmanager.versions.list
      - secretmanager.versions.access
      - cloudkms.keyRings.list
      - cloudkms.cryptoKeys.list
      - cloudkms.cryptoKeys.get

  # Admin - full access to secrets and keys
  roles/custom.admin:
    permissions:
      # Secret Manager permissions
      - secretmanager.secrets.create
      - secretmanager.secrets.get
      - secretmanager.secrets.list
      - secretmanager.secrets.update
      - secretmanager.secrets.delete
      - secretmanager.versions.add
      - secretmanager.versions.access
      - secretmanager.versions.list
      - secretmanager.versions.enable
      - secretmanager.versions.disable
      - secretmanager.versions.destroy
      # KMS permissions
      - cloudkms.keyRings.create
      - cloudkms.keyRings.get
      - cloudkms.keyRings.list
      - cloudkms.cryptoKeys.create
      - cloudkms.cryptoKeys.get
      - cloudkms.cryptoKeys.list
      - cloudkms.cryptoKeys.update
      - cloudkms.cryptoKeys.encrypt
      - cloudkms.cryptoKeys.decrypt
      - cloudkms.cryptoKeyVersions.create
      - cloudkms.cryptoKeyVersions.get
      - cloudkms.cryptoKeyVersions.list
      - cloudkms.cryptoKeyVersions.update
      - cloudkms.cryptoKeyVersions.destroy

# Groups
# Define reusable principal collections
groups:
  developers:
    members:
      - user:alice@example.com
      - user:bob@example.com
      - user:charlie@example.com

  admins:
    members:
      - user:admin@example.com
      - group:developers  # Admins include all developers

# Projects
# Define IAM policies per project
projects:
  test-project:
    bindings:
      # Admins have full access
      - role: roles/custom.admin
        members:
          - group:admins

      # Developers have read access
      - role: roles/custom.developer
        members:
          - group:developers

      # CI runner has limited access to production secrets only
      - role: roles/custom.ciRunner
        members:
          - serviceAccount:ci@test-project.iam.gserviceaccount.com
        condition:
          expression: 'resource.name.startsWith("projects/test-project/secrets/prod-")'
          title: "CI limited to production secrets"

  # Example: Different project with different policies
  staging-project:
    bindings:
      - role: roles/custom.developer
        members:
          - user:alice@example.com
          - serviceAccount:ci@test-project.iam.gserviceaccount.com
